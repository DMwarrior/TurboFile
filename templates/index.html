<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æé€Ÿä¼  - é«˜é€Ÿæ–‡ä»¶ä¼ è¾“ç³»ç»Ÿ</title>

    <!-- Favicon - é—ªç”µå›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%23ffc107' d='M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09z'/></svg>" type="image/svg+xml">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #f59e0b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container-fluid {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            margin: 2px;
            padding: 6px;
            max-width: calc(100vw - 4px);
            height: calc(100vh - 4px);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .file-browser {
            height: calc(var(--browse-height, 50vh));
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            /* é˜²æ­¢æ»šåŠ¨äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´  */
            overscroll-behavior: contain;
            /* ç¡®ä¿æ»šåŠ¨å¹³æ»‘ */
            scroll-behavior: smooth;
            /* è®¾ç½®æ»šåŠ¨æ¡æ ·å¼ */
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
            /* ç¡®ä¿å†…å®¹å¯ä»¥å®Œå…¨æ»šåŠ¨ */
            box-sizing: border-box;
            position: relative;
        }

        .file-browser:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        /* WebKitæµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ */
        .file-browser::-webkit-scrollbar {
            width: 8px;
        }

        .file-browser::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }

        .file-browser::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .file-browser::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .file-item {
            cursor: pointer;
            padding: 6px 10px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.85rem;
            line-height: 1.4;
            user-select: none;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin: 1px 2px 1px 2px;
            /* ç¡®ä¿æœ€åä¸€ä¸ªæ–‡ä»¶é¡¹æœ‰è¶³å¤Ÿçš„åº•éƒ¨é—´è· */
            min-height: 36px;
        }

        .file-item:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .file-item.selected {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .file-item.selected:hover {
            background: var(--gradient-primary);
            filter: brightness(1.1);
        }

        .file-item i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
            font-size: 0.8rem;
        }

        .file-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            flex: 1;
            font-weight: 500;
        }

        .file-details {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-left: 10px;
            font-weight: 400;
        }

        .file-item.selected .file-details {
            opacity: 0.9;
        }

        .progress-container {
            display: none;
        }

        .server-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 3px 5px;
            margin-bottom: 2px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .server-panel:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }



        /* æ‹–æ‹½ç›¸å…³æ ·å¼ */
        .file-item.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(0.95);
        }

        .file-browser.drag-over {
            border: 3px dashed var(--primary-color);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼å·²ç§»é™¤ï¼Œå®ç°æ— æ„ŸåŒå‡» */

        /* é”™è¯¯çŠ¶æ€æ ·å¼ */
        .error-state {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #fecaca;
            border-radius: 8px;
        }

        /* è¿”å›ä¸Šçº§ç›®å½•æ ·å¼ä¼˜åŒ– */
        .file-item[title*="åŒå‡»è¿”å›"] {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #bfdbfe;
            margin-bottom: 8px;
        }

        .file-item[title*="åŒå‡»è¿”å›"]:hover {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: translateX(6px);
            box-shadow: var(--shadow-md);
        }

        /* åŒå‡»å“åº”ä¼˜åŒ– - ä¿ç•™åŸºæœ¬äº¤äº’æ•ˆæœ */
        .file-item:active {
            transform: scale(0.98);
            transition: transform 0.05s ease-out;
        }

        /* ç¡®ä¿æœ€åä¸€ä¸ªæ–‡ä»¶é¡¹æœ‰è¶³å¤Ÿçš„åº•éƒ¨é—´è· */
        .file-item:last-child {
            margin-bottom: 15px;
        }

        /* åˆ·æ–°çŠ¶æ€åŠ¨ç”»å·²ç§»é™¤ */

        /* åˆ·æ–°æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .btn-outline-primary:hover, .btn-outline-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-outline-primary:active, .btn-outline-success:active {
            transform: translateY(0);
        }

        /* å¼ºåˆ¶ä¿æŒé»˜è®¤å…‰æ ‡æ ·å¼ */
        body, html {
            cursor: default !important;
        }

        .file-item, .file-item * {
            cursor: pointer !important;
        }

        .path-segment, .path-segment * {
            cursor: pointer !important;
        }

        .resizer {
            cursor: col-resize !important;
        }

        body.browsing .path-segment, body.browsing .path-segment * {
            cursor: pointer !important;
        }

        .drag-preview {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            background: var(--gradient-primary);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        /* åˆ†éš”æ¡æ ·å¼ */
        .resizer {
            background: linear-gradient(135deg, var(--border-color) 0%, #cbd5e1 100%);
            cursor: col-resize;
            width: 8px;
            position: relative;
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .resizer:hover {
            background: var(--gradient-primary);
            transform: scaleX(1.2);
        }



        /* è·¯å¾„å¯¼èˆªæ ·å¼ */
        .path-nav {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .path-nav:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .path-segment {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .path-segment:hover {
            background: var(--primary-color);
            color: white;
            text-decoration: none;
        }

        .path-separator {
            margin: 0 6px;
            color: var(--text-secondary);
            font-weight: 300;
        }

        /* è°ƒæ•´å®¹å™¨å¸ƒå±€ */
        .resizable-container {
            display: flex;
            height: 100%;
            gap: 8px;
        }

        .resizable-panel {
            overflow: visible;
            background: var(--card-bg);
            border-radius: 6px;
            padding: 3px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            /* ç¡®ä¿é¢æ¿å†…çš„æ»šåŠ¨ä¸å½±å“å¤–éƒ¨ */
            position: relative;
        }

        .resizable-panel:hover {
            box-shadow: var(--shadow-md);
        }
        /* ç°ä»£åŒ–æŒ‰é’®æ ·å¼ */
        .btn {
            border-radius: 4px;
            font-weight: 500;
            padding: 6px 12px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: var(--shadow-sm);
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--gradient-primary);
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: white;
        }

        .btn-outline-secondary {
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            background: var(--card-bg);
        }

        .btn-outline-secondary:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        /* è¡¨å•æ§ä»¶æ ·å¼ */
        .form-select, .form-control {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 8px;
            transition: all 0.3s ease;
            background: var(--card-bg);
            font-size: 0.9rem;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: var(--card-bg);
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            background: var(--card-bg);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-body {
            padding: 4px 6px;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress {
            border-radius: 10px;
            background: var(--light-bg);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .progress-bar {
            background: var(--gradient-success);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }

        /* æ ‡é¢˜æ ·å¼ */
        h4, h6 {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            margin-top: 1px;
        }

        .main-title {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
            line-height: 1;
            display: flex;
            align-items: center;
        }

        /* å…¬å¸å“ç‰Œæ•´ä½“æ ·å¼ */
        .company-brand {
            transition: all 0.3s ease;
            filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.1));
            display: flex;
            align-items: center;
            height: 32px; /* ä¸æ ‡é¢˜é«˜åº¦ä¸€è‡´ */
        }

        .company-brand:hover {
            transform: scale(1.03);
            filter: drop-shadow(0 2px 6px rgba(20, 184, 166, 0.2));
        }

        .company-brand svg {
            vertical-align: middle;
        }

        /* äº§å“å“ç‰Œæ•´ä½“æ ·å¼ */
        .product-brand {
            display: flex;
            align-items: center;
            height: 32px;
        }





        /* å“åº”å¼å“ç‰Œè°ƒæ•´ */
        @media (max-width: 768px) {
            .company-brand {
                height: 26px;
                margin-right: 30px !important;
            }

            .company-brand svg {
                width: 130px;
                height: 26px;
            }

            .product-brand {
                height: 26px;
                margin-left: 12px !important;
            }

            .main-title {
                font-size: 1.0rem;
            }
        }

        @media (max-width: 480px) {
            .company-brand {
                height: 22px;
                margin-right: 20px !important;
            }

            .company-brand svg {
                width: 110px;
                height: 22px;
            }

            .product-brand {
                height: 22px;
                margin-left: 10px !important;
            }

            .main-title {
                font-size: 0.9rem;
            }
        }

        /* ç¡®ä¿å®Œå…¨å•å±æ˜¾ç¤º */
        .flex-shrink-0 {
            flex-shrink: 0;
        }

        .flex-grow-1 {
            flex-grow: 1;
            min-height: 0;
        }

        /* é˜²æ­¢æ»šåŠ¨å†²çªçš„é¢å¤–æ ·å¼ */
        .resizable-container {
            /* ç¡®ä¿å®¹å™¨ä¸ä¼šäº§ç”Ÿæ»šåŠ¨æ¡ */
            overflow: hidden;
            /* é˜²æ­¢æ»šåŠ¨äº‹ä»¶ä¼ æ’­ */
            overscroll-behavior: contain;
        }

        /* ç¡®ä¿æ–‡ä»¶æµè§ˆå™¨åŒºåŸŸçš„æ»šåŠ¨ç‹¬ç«‹æ€§ */
        #sourceFileBrowser, #targetFileBrowser {
            /* é˜²æ­¢æ»šåŠ¨äº‹ä»¶å†’æ³¡ */
            overscroll-behavior: contain;
            /* ç¡®ä¿æ»šåŠ¨åŒºåŸŸæ˜ç¡®å®šä¹‰ */
            position: relative;
            /* ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
            will-change: scroll-position;
            /* ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨æ—¶æœ‰è¶³å¤Ÿçš„ç©ºé—´ */
            scroll-padding-bottom: 20px;
        }

        /* æ—¥å¿—åŒºåŸŸæ ·å¼ */
        .log-container {
            height: 120px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #f8f9fa;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.75rem;
            line-height: 1.3;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
        }

        .log-content {
            padding: 6px 8px;
            min-height: 100%;
        }

        .log-entry {
            margin-bottom: 2px;
            padding: 2px 4px;
            border-radius: 2px;
            word-wrap: break-word;
            animation: logFadeIn 0.3s ease-in;
        }

        .log-entry.log-info {
            color: #0066cc;
            background: rgba(0, 102, 204, 0.05);
        }

        .log-entry.log-success {
            color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }

        .log-entry.log-warning {
            color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .log-entry.log-error {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .log-timestamp {
            color: #6c757d;
            font-size: 0.7rem;
            margin-right: 6px;
        }

        @keyframes logFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ—¥å¿—æ»šåŠ¨æ¡æ ·å¼ */
        .log-container::-webkit-scrollbar {
            width: 6px;
        }

        .log-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .log-container::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* è·¯å¾„å¯¼èˆªä¼˜åŒ– */
        .path-nav {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2px 6px;
            margin-bottom: 4px;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: var(--shadow-sm);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container-fluid {
                margin: 1px;
                padding: 4px;
                border-radius: 6px;
            }

            .resizable-container {
                flex-direction: column;
                gap: 4px;
            }

            .resizable-panel {
                padding: 3px;
            }

            .main-title {
                font-size: 1.0rem;
                margin: 0;
            }

            .server-panel {
                padding: 3px 5px;
                margin-bottom: 2px;
            }

            .file-item {
                padding: 4px 6px;
                font-size: 0.8rem;
            }

            .btn {
                font-size: 0.85rem;
                padding: 5px 10px;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 576px) {
            .col-md-6 {
                padding-left: 3px;
                padding-right: 3px;
            }

            .input-group .btn {
                padding: 4px 8px;
                font-size: 0.8rem;
            }

            .main-title {
                font-size: 0.9rem;
                margin: 0;
            }

            .file-item {
                font-size: 0.75rem;
                padding: 3px 5px;
            }
        }

        /* é«˜åº¦é™åˆ¶ä¼˜åŒ– */
        @media (max-height: 800px) {
            .main-title {
                font-size: 0.95rem;
                margin: 0;
            }

            .server-panel {
                padding: 2px 4px;
                margin-bottom: 1px;
            }

            .card-body {
                padding: 3px 5px;
            }

            .file-item {
                padding: 4px 6px;
            }

            .btn {
                padding: 4px 8px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid" style="position: relative;">


        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <div class="row flex-shrink-0" style="margin-bottom: 2px;">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-center">
                    <!-- TAIHOå…¬å¸æ•´ä½“ (LOGO + TAIHO + æ³°ç¦¾) -->
                    <div class="company-brand d-flex align-items-center" style="margin-right: 40px;">
                        <svg width="160" height="32" viewBox="0 0 160 36" xmlns="http://www.w3.org/2000/svg">
                            <!-- TAIHOæ ‡å¿—æ€§å‡ ä½•å›¾å½¢ -->
                            <g>
                                <!-- å·¦ä¾§å›¾æ ‡ - ç°ä»£åŒ–å‡ ä½•è®¾è®¡ -->
                                <rect x="2" y="6" width="10" height="24" fill="#14b8a6" rx="2"/>
                                <rect x="16" y="6" width="10" height="24" fill="#0891b2" rx="2"/>
                                <!-- è¿æ¥å…ƒç´  -->
                                <circle cx="7" cy="9" r="2" fill="#06b6d4"/>
                                <circle cx="21" cy="9" r="2" fill="#0284c7"/>

                                <!-- TAIHOæ–‡å­— - ä¸LOGOä¿æŒç›¸åŒè·ç¦»ï¼Œä½¿ç”¨ä¸æ³°ç¦¾ç›¸åŒçš„é¢œè‰² -->
                                <text x="32" y="26" font-family="'Segoe UI', Arial, sans-serif" font-size="18" font-weight="700" fill="#14b8a6">TAIHO</text>
                                <!-- æ³°ç¦¾æ–‡å­— - ä¸TAIHOä¿æŒä¸LOGOåˆ°TAIHOç›¸åŒçš„è·ç¦» -->
                                <text x="102" y="26" font-family="'Microsoft YaHei', sans-serif" font-size="18" font-weight="700" fill="#14b8a6">æ³°ç¦¾</text>
                            </g>
                        </svg>
                    </div>

                    <!-- æé€Ÿä¼ æ ‡é¢˜æ•´ä½“ - ä¸ç›®æ ‡æœåŠ¡å™¨å·¦è¾¹å¯¹é½ -->
                    <div class="product-brand d-flex align-items-center" style="margin-left: 15px;">
                        <h4 class="main-title d-flex align-items-center" style="margin: 0; line-height: 1;">
                            <i class="bi bi-lightning-charge-fill" style="color: #ffc107; font-size: 1.0em; margin-right: 6px;"></i>
                            <span>æé€Ÿä¼ </span>
                        </h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœåŠ¡å™¨é€‰æ‹©é¢æ¿ -->
        <div class="row g-1 flex-shrink-0" style="margin-bottom: 3px;">
            <div class="col-md-6">
                <div class="server-panel" style="padding: 4px 6px;">
                    <h6 style="font-size: 0.85rem; margin-bottom: 2px;">
                        <i class="bi bi-hdd-network-fill text-primary"></i> æºæœåŠ¡å™¨
                    </h6>
                    <select id="sourceServer" class="form-select mb-1" style="font-size: 0.85rem;">
                        <option value="">ğŸ” è¯·é€‰æ‹©æºæœåŠ¡å™¨</option>
                        {% for ip, info in servers.items() %}
                        <option value="{{ ip }}">ğŸ–¥ï¸ {{ info.name }} ({{ ip }})</option>
                        {% endfor %}
                    </select>
                    <div class="input-group">
                        <span class="input-group-text" style="padding: 4px 6px;">
                            <i class="bi bi-folder2-open text-warning" style="font-size: 0.85rem;"></i>
                        </span>
                        <input type="text" id="sourcePath" class="form-control" placeholder="æºè·¯å¾„" value="">
                        <button class="btn btn-outline-primary" onclick="refreshSource()" title="åˆ·æ–°ç›®å½•å†…å®¹">
                            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="server-panel" style="padding: 4px 6px;">
                    <h6 style="font-size: 0.85rem; margin-bottom: 2px;">
                        <i class="bi bi-cloud-upload-fill text-success"></i> ç›®æ ‡æœåŠ¡å™¨
                    </h6>
                    <select id="targetServer" class="form-select mb-1" style="font-size: 0.85rem;">
                        <option value="">ğŸ¯ è¯·é€‰æ‹©ç›®æ ‡æœåŠ¡å™¨</option>
                        {% for ip, info in servers.items() %}
                        <option value="{{ ip }}">ğŸ–¥ï¸ {{ info.name }} ({{ ip }})</option>
                        {% endfor %}
                    </select>
                    <div class="input-group">
                        <span class="input-group-text" style="padding: 4px 6px;">
                            <i class="bi bi-folder-plus text-success" style="font-size: 0.85rem;"></i>
                        </span>
                        <input type="text" id="targetPath" class="form-control" placeholder="ç›®æ ‡è·¯å¾„" value="">
                        <button class="btn btn-outline-success" onclick="refreshTarget()" title="åˆ·æ–°ç›®å½•å†…å®¹">
                            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶æµè§ˆå™¨ -->
        <div class="row flex-grow-1" style="min-height: 0;">
            <div class="resizable-container" style="height: 100%;">
                <div class="resizable-panel" id="sourcePanel" style="width: 50%; height: 100%;">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 style="font-size: 0.9rem; margin-bottom: 0;">
                            <i class="bi bi-files text-info"></i> æºæ–‡ä»¶æµè§ˆ
                        </h6>
                        <div class="form-check form-switch" style="font-size: 0.75rem;">
                            <input class="form-check-input" type="checkbox" id="sourceShowHidden" onchange="toggleHiddenFiles('source')">
                            <label class="form-check-label" for="sourceShowHidden" style="font-size: 0.75rem;">
                                æ˜¾ç¤ºéšè—æ–‡ä»¶
                            </label>
                        </div>
                    </div>
                    <div id="sourcePathNav" class="path-nav" style="display: none; padding: 3px 8px; font-size: 0.8rem;">
                        <i class="bi bi-geo-alt-fill text-primary me-1"></i>
                        <span id="sourcePathDisplay">/</span>
                    </div>
                    <div id="sourceFileBrowser" class="file-browser" style="height: calc(100% - 50px); padding-bottom: 10px;">
                        <div class="text-center text-muted p-3">
                            <i class="bi bi-server fs-3 mb-2 d-block opacity-50"></i>
                            <p class="mb-0" style="font-size: 0.85rem;">è¯·å…ˆé€‰æ‹©æºæœåŠ¡å™¨</p>
                        </div>
                    </div>
                </div>

                <div class="resizer" id="verticalResizer"></div>

                <div class="resizable-panel" id="targetPanel" style="width: 50%; height: 100%;">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 style="font-size: 0.9rem; margin-bottom: 0;">
                            <i class="bi bi-folder-check text-success"></i> ç›®æ ‡ç›®å½•æµè§ˆ
                        </h6>
                        <div class="form-check form-switch" style="font-size: 0.75rem;">
                            <input class="form-check-input" type="checkbox" id="targetShowHidden" onchange="toggleHiddenFiles('target')">
                            <label class="form-check-label" for="targetShowHidden" style="font-size: 0.75rem;">
                                æ˜¾ç¤ºéšè—æ–‡ä»¶
                            </label>
                        </div>
                    </div>
                    <div id="targetPathNav" class="path-nav" style="display: none; padding: 3px 8px; font-size: 0.8rem;">
                        <i class="bi bi-geo-alt-fill text-success me-1"></i>
                        <span id="targetPathDisplay">/</span>
                    </div>
                    <div id="targetFileBrowser" class="file-browser" style="height: calc(100% - 50px); padding-bottom: 10px;">
                        <div class="text-center text-muted p-3">
                            <i class="bi bi-cloud-upload fs-3 mb-2 d-block opacity-50"></i>
                            <p class="mb-0" style="font-size: 0.85rem;">è¯·å…ˆé€‰æ‹©ç›®æ ‡æœåŠ¡å™¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¼ è¾“æ§åˆ¶é¢æ¿ -->
        <div class="row flex-shrink-0">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center g-1">
                            <div class="col-md-3">
                                <select id="transferMode" class="form-select form-select-sm">
                                    <option value="copy">ğŸ“‹ å¤åˆ¶</option>
                                    <option value="move">âœ‚ï¸ ç§»åŠ¨</option>
                                </select>
                            </div>
                            <div class="col-md-6 text-center">
                                <button id="startTransferBtn" class="btn btn-primary me-2" onclick="startTransfer()">
                                    <i class="bi bi-lightning-charge-fill"></i> å¼€å§‹ä¼ è¾“
                                </button>
                                <button id="cancelTransferBtn" class="btn btn-danger" onclick="cancelTransfer()" ondblclick="forceCancelTransfer()" style="display: none;" title="å•å‡»å–æ¶ˆä¼ è¾“ï¼ŒåŒå‡»å¼ºåˆ¶ç»ˆæ­¢">
                                    <i class="bi bi-stop-circle-fill"></i> å–æ¶ˆä¼ è¾“
                                </button>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch mb-1">
                                    <input class="form-check-input" type="checkbox" id="fastSSH" checked>
                                    <label class="form-check-label" style="font-size: 0.85rem;" for="fastSSH">
                                        ğŸš€ SSHåŠ é€Ÿ
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="parallelTransfer" checked>
                                    <label class="form-check-label" style="font-size: 0.85rem;" for="parallelTransfer">
                                        âš¡ å¹¶è¡Œä¼ è¾“ (ç«‹å³å¼€å§‹)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="row flex-shrink-0">
            <div class="col-12">
                <div id="progressContainer" class="progress-container">
                    <div class="card">
                        <div class="card-body">
                            <!-- ä¼ è¾“è·¯å¾„æ˜¾ç¤º -->
                            <div class="transfer-route mb-2 p-2 bg-light rounded" style="height: 40px; display: flex; align-items: center; justify-content: center;">
                                <div id="transferRoute" class="fw-bold text-primary" style="font-size: 14px;">
                                    <i class="bi bi-arrow-right-circle-fill me-1"></i>
                                    å‡†å¤‡ä¼ è¾“...
                                </div>
                            </div>
                            <div class="row g-2">
                                <div class="col-6 col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-speedometer text-info me-1" style="font-size: 0.85rem;"></i>
                                        <div>
                                            <small class="text-muted" style="font-size: 0.75em;">é€Ÿåº¦</small>
                                            <div id="transferSpeed" class="fw-bold" style="font-size: 0.85rem;">-</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-download text-success me-1" style="font-size: 0.85rem;"></i>
                                        <div>
                                            <small class="text-muted" style="font-size: 0.75em;">å·²ä¼ è¾“</small>
                                            <div id="transferredBytes" class="fw-bold" style="font-size: 0.85rem;">-</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-clock text-warning me-1" style="font-size: 0.85rem;"></i>
                                        <div>
                                            <small class="text-muted" style="font-size: 0.75em;">å·²ç”¨æ—¶é—´</small>
                                            <div id="elapsedTime" class="fw-bold" style="font-size: 0.85rem;">00:00:00</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle text-primary me-1" style="font-size: 0.85rem;"></i>
                                        <div>
                                            <small class="text-muted" style="font-size: 0.75em;">çŠ¶æ€</small>
                                            <div id="transferStatus" class="fw-bold" style="font-size: 0.85rem;">å‡†å¤‡ä¸­</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¼ è¾“æ—¥å¿—åŒºåŸŸ -->
        <div class="row flex-shrink-0">
            <div class="col-12">
                <div class="card">
                    <div class="card-body" style="padding: 4px 6px;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 style="font-size: 0.85rem; margin-bottom: 0;">
                                <i class="bi bi-journal-text text-secondary"></i> ä¼ è¾“æ—¥å¿—
                            </h6>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearLog()" style="font-size: 0.7rem; padding: 1px 6px;">
                                <i class="bi bi-trash3"></i> æ¸…ç©º
                            </button>
                        </div>
                        <div id="logContainer" class="log-container">
                            <div id="logContent" class="log-content">
                                <!-- æ—¥å¿—å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        // WebSocketè¿æ¥
        const socket = io();
        let currentTransferId = null;
        let selectedSourceFiles = [];
        let currentSourcePath = '/home/th';
        let currentTargetPath = '/home/thgd';

        // æ—¥å¿—ç³»ç»Ÿé…ç½®
        let logBuffer = [];
        let logUpdateTimer = null;
        let isTransferring = false;
        const MAX_LOG_ENTRIES = 100;
        const LOG_UPDATE_INTERVAL = 500; // 500msæ‰¹é‡æ›´æ–°

        // æ™ºèƒ½æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            // ä¼ è¾“è¿‡ç¨‹ä¸­è¿‡æ»¤è¯¦ç»†è¿›åº¦ä¿¡æ¯
            if (isTransferring && isProgressMessage(message)) {
                return;
            }

            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp: timestamp,
                message: message,
                type: type,
                id: Date.now() + Math.random()
            };

            // æ·»åŠ åˆ°ç¼“å†²åŒº
            logBuffer.push(logEntry);

            // æ§åˆ¶å°è¾“å‡ºï¼ˆè°ƒè¯•ç”¨ï¼‰
            console.log(`[${timestamp}] ${message}`);

            // æ‰¹é‡æ›´æ–°UI
            scheduleLogUpdate();
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºè¿›åº¦æ¶ˆæ¯ï¼ˆä¼ è¾“æ—¶éœ€è¦è¿‡æ»¤ï¼‰
        function isProgressMessage(message) {
            const progressKeywords = [
                'å­—èŠ‚', 'bytes', '%', 'MB/s', 'KB/s', 'GB/s',
                'è¿›åº¦', 'progress', 'ä¼ è¾“é€Ÿåº¦', 'å‰©ä½™æ—¶é—´'
            ];
            return progressKeywords.some(keyword => message.includes(keyword));
        }

        // è°ƒåº¦æ—¥å¿—æ›´æ–°
        function scheduleLogUpdate() {
            if (logUpdateTimer) {
                clearTimeout(logUpdateTimer);
            }

            logUpdateTimer = setTimeout(() => {
                updateLogDisplay();
                logUpdateTimer = null;
            }, LOG_UPDATE_INTERVAL);
        }

        // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        function updateLogDisplay() {
            if (logBuffer.length === 0) return;

            const logContent = document.getElementById('logContent');
            const logContainer = document.getElementById('logContainer');

            // æ‰¹é‡å¤„ç†æ—¥å¿—æ¡ç›®
            const fragment = document.createDocumentFragment();

            logBuffer.forEach(entry => {
                const logDiv = document.createElement('div');
                logDiv.className = `log-entry log-${entry.type}`;
                logDiv.innerHTML = `
                    <span class="log-timestamp">${entry.timestamp}</span>
                    <span class="log-message">${escapeHtml(entry.message)}</span>
                `;
                fragment.appendChild(logDiv);
            });

            logContent.appendChild(fragment);

            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            const entries = logContent.querySelectorAll('.log-entry');
            if (entries.length > MAX_LOG_ENTRIES) {
                const removeCount = entries.length - MAX_LOG_ENTRIES;
                for (let i = 0; i < removeCount; i++) {
                    entries[i].remove();
                }
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logContainer.scrollTop = logContainer.scrollHeight;

            // æ¸…ç©ºç¼“å†²åŒº
            logBuffer = [];
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
            logBuffer = [];
            addLog('ğŸ“ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // æ·»åŠ ä¸åŒç±»å‹çš„æ—¥å¿—å‡½æ•°
        function addLogInfo(message) {
            addLog(message, 'info');
        }

        function addLogSuccess(message) {
            addLog(message, 'success');
        }

        function addLogWarning(message) {
            addLog(message, 'warning');
        }

        function addLogError(message) {
            addLog(message, 'error');
        }

        // æµè§ˆæºæ–‡ä»¶ - åŒæ­¥ç‰ˆæœ¬ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
        function browseSource() {
            browseSourceAsync();
        }

        // åˆ·æ–°æºæ–‡ä»¶ - å¼ºåˆ¶æ¸…é™¤ç¼“å­˜
        function refreshSource() {
            refreshSourceAsync();
        }

        // æµè§ˆæºæ–‡ä»¶ - å¼‚æ­¥ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆæ— åŠ è½½åŠ¨ç”»ï¼‰
        async function browseSourceAsync() {
            const server = document.getElementById('sourceServer').value;
            const path = document.getElementById('sourcePath').value;
            const showHidden = document.getElementById('sourceShowHidden').checked;

            if (!server) {
                alert('è¯·å…ˆé€‰æ‹©æºæœåŠ¡å™¨');
                return;
            }

            try {
                // ä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é‡å¤è¯·æ±‚
                if (window.sourceRequestController) {
                    window.sourceRequestController.abort();
                }
                window.sourceRequestController = new AbortController();

                const response = await fetch(`/api/browse/${server}?path=${encodeURIComponent(path)}&show_hidden=${showHidden}`, {
                    signal: window.sourceRequestController.signal
                });

                const data = await response.json();

                if (data.success) {
                    // ç›´æ¥æ˜¾ç¤ºæ–‡ä»¶ï¼Œæ— åŠ è½½åŠ¨ç”»
                    displayFiles('sourceFileBrowser', data.files, path, true);
                    addLogInfo(`ğŸ“ å·²åŠ è½½æºç›®å½•: ${path} (${data.files.length}é¡¹)`);
                } else {
                    showErrorState('sourceFileBrowser', 'æµè§ˆå¤±è´¥: ' + data.error);
                    addLogError(`âŒ æµè§ˆæºç›®å½•å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    showErrorState('sourceFileBrowser', 'æµè§ˆå¤±è´¥: ' + error.message);
                    addLogError(`âŒ æµè§ˆæºç›®å½•å‡ºé”™: ${error}`);
                }
            }
        }

        // ç«‹å³å“åº”çš„æºæ–‡ä»¶æµè§ˆ - é›¶å»¶è¿Ÿæ— åŠ¨ç”»ç‰ˆæœ¬
        async function browseSourceInstant(targetPath) {
            const server = document.getElementById('sourceServer').value;
            const showHidden = document.getElementById('sourceShowHidden').checked;

            if (!server) {
                alert('è¯·å…ˆé€‰æ‹©æºæœåŠ¡å™¨');
                return;
            }

            try {
                // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
                if (window.sourceInstantController) {
                    window.sourceInstantController.abort();
                }
                window.sourceInstantController = new AbortController();

                // ç«‹å³å‘èµ·è¯·æ±‚ï¼Œæ— ä»»ä½•å»¶è¿Ÿå’ŒåŠ è½½åŠ¨ç”»
                const startTime = performance.now();
                console.log(`[æºæ–‡ä»¶æµè§ˆ] å¼€å§‹è¯·æ±‚: ${targetPath}`);

                const response = await fetch(`/api/browse/${server}?path=${encodeURIComponent(targetPath)}&show_hidden=${showHidden}`, {
                    signal: window.sourceInstantController.signal,
                    // æ·»åŠ ç¼“å­˜æ§åˆ¶ï¼Œä¼˜åŒ–é‡å¤è®¿é—®
                    cache: 'default'
                });

                const data = await response.json();
                const endTime = performance.now();
                console.log(`[æºæ–‡ä»¶æµè§ˆ] è¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);

                if (data.success) {
                    // ç›´æ¥æ˜¾ç¤ºæ–‡ä»¶ï¼Œæ— åŠ è½½åŠ¨ç”»
                    displayFiles('sourceFileBrowser', data.files, targetPath, true);
                    addLogInfo(`ğŸ“ å·²è¿›å…¥æºç›®å½•: ${targetPath} (${data.files.length}é¡¹) - ${(endTime - startTime).toFixed(0)}ms`);
                } else {
                    showErrorState('sourceFileBrowser', 'æµè§ˆå¤±è´¥: ' + data.error);
                    addLogError(`âŒ æµè§ˆæºç›®å½•å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    showErrorState('sourceFileBrowser', 'æµè§ˆå¤±è´¥: ' + error.message);
                    addLogError(`âŒ æµè§ˆæºç›®å½•å‡ºé”™: ${error}`);
                }
            }
        }

        // åˆ·æ–°æºæ–‡ä»¶ - å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ç‰ˆæœ¬ï¼ˆæ— åŠ è½½åŠ¨ç”»ï¼‰
        async function refreshSourceAsync() {
            const server = document.getElementById('sourceServer').value;
            const path = document.getElementById('sourcePath').value;
            const showHidden = document.getElementById('sourceShowHidden').checked;

            if (!server) {
                alert('è¯·å…ˆé€‰æ‹©æºæœåŠ¡å™¨');
                return;
            }

            try {
                // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
                if (window.sourceRefreshController) {
                    window.sourceRefreshController.abort();
                }
                window.sourceRefreshController = new AbortController();

                // å‘èµ·å¼ºåˆ¶åˆ·æ–°è¯·æ±‚
                const startTime = performance.now();
                console.log(`[æºæ–‡ä»¶åˆ·æ–°] å¼ºåˆ¶åˆ·æ–°: ${path}`);

                const response = await fetch(`/api/browse/${server}?path=${encodeURIComponent(path)}&show_hidden=${showHidden}&force_refresh=true`, {
                    signal: window.sourceRefreshController.signal,
                    // å¼ºåˆ¶åˆ·æ–°ä¸ä½¿ç”¨ç¼“å­˜
                    cache: 'no-cache'
                });

                const data = await response.json();
                const endTime = performance.now();
                console.log(`[æºæ–‡ä»¶åˆ·æ–°] åˆ·æ–°å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);

                if (data.success) {
                    // ç›´æ¥æ˜¾ç¤ºæ–‡ä»¶ï¼Œæ— åŠ è½½åŠ¨ç”»
                    displayFiles('sourceFileBrowser', data.files, path, true);
                    const cacheInfo = data.cache_cleared > 0 ? ` (æ¸…é™¤${data.cache_cleared}ä¸ªç¼“å­˜)` : '';
                    addLogSuccess(`ğŸ”„ å·²åˆ·æ–°æºç›®å½•: ${path} (${data.files.length}é¡¹) - ${(endTime - startTime).toFixed(0)}ms${cacheInfo}`);
                } else {
                    showErrorState('sourceFileBrowser', 'åˆ·æ–°å¤±è´¥: ' + data.error);
                    addLogError(`âŒ åˆ·æ–°æºç›®å½•å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    showErrorState('sourceFileBrowser', 'åˆ·æ–°å¤±è´¥: ' + error.message);
                    addLogError(`âŒ åˆ·æ–°æºç›®å½•å‡ºé”™: ${error}`);
                }
            }
        }

        // æµè§ˆç›®æ ‡æ–‡ä»¶ - åŒæ­¥ç‰ˆæœ¬ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
        function browseTarget() {
            browseTargetAsync();
        }

        // åˆ·æ–°ç›®æ ‡æ–‡ä»¶ - å¼ºåˆ¶æ¸…é™¤ç¼“å­˜
        function refreshTarget() {
            refreshTargetAsync();
        }

        // æµè§ˆç›®æ ‡æ–‡ä»¶ - å¼‚æ­¥ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆæ— åŠ è½½åŠ¨ç”»ï¼‰
        async function browseTargetAsync() {
            const server = document.getElementById('targetServer').value;
            const path = document.getElementById('targetPath').value;
            const showHidden = document.getElementById('targetShowHidden').checked;

            if (!server) {
                alert('è¯·å…ˆé€‰æ‹©ç›®æ ‡æœåŠ¡å™¨');
                return;
            }

            try {
                // ä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é‡å¤è¯·æ±‚
                if (window.targetRequestController) {
                    window.targetRequestController.abort();
                }
                window.targetRequestController = new AbortController();

                const response = await fetch(`/api/browse/${server}?path=${encodeURIComponent(path)}&show_hidden=${showHidden}`, {
                    signal: window.targetRequestController.signal
                });

                const data = await response.json();

                if (data.success) {
                    // ç›´æ¥æ˜¾ç¤ºæ–‡ä»¶ï¼Œæ— åŠ è½½åŠ¨ç”»
                    displayFiles('targetFileBrowser', data.files, path, false);
                    addLogInfo(`ğŸ“‚ å·²åŠ è½½ç›®æ ‡ç›®å½•: ${path} (${data.files.length}é¡¹)`);
                } else {
                    showErrorState('targetFileBrowser', 'æµè§ˆå¤±è´¥: ' + data.error);
                    addLogError(`âŒ æµè§ˆç›®æ ‡ç›®å½•å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    showErrorState('targetFileBrowser', 'æµè§ˆå¤±è´¥: ' + error.message);
                    addLogError(`âŒ æµè§ˆç›®æ ‡ç›®å½•å‡ºé”™: ${error}`);
                }
            }
        }

        // ç«‹å³å“åº”çš„ç›®æ ‡æ–‡ä»¶æµè§ˆ - é›¶å»¶è¿Ÿæ— åŠ¨ç”»ç‰ˆæœ¬
        async function browseTargetInstant(targetPath) {
            const server = document.getElementById('targetServer').value;
            const showHidden = document.getElementById('targetShowHidden').checked;

            if (!server) {
                alert('è¯·å…ˆé€‰æ‹©ç›®æ ‡æœåŠ¡å™¨');
                return;
            }

            try {
                // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
                if (window.targetInstantController) {
                    window.targetInstantController.abort();
                }
                window.targetInstantController = new AbortController();

                // ç«‹å³å‘èµ·è¯·æ±‚ï¼Œæ— ä»»ä½•å»¶è¿Ÿå’ŒåŠ è½½åŠ¨ç”»
                const startTime = performance.now();
                console.log(`[ç›®æ ‡æ–‡ä»¶æµè§ˆ] å¼€å§‹è¯·æ±‚: ${targetPath}`);

                const response = await fetch(`/api/browse/${server}?path=${encodeURIComponent(targetPath)}&show_hidden=${showHidden}`, {
                    signal: window.targetInstantController.signal,
                    // æ·»åŠ ç¼“å­˜æ§åˆ¶ï¼Œä¼˜åŒ–é‡å¤è®¿é—®
                    cache: 'default'
                });

                const data = await response.json();
                const endTime = performance.now();
                console.log(`[ç›®æ ‡æ–‡ä»¶æµè§ˆ] è¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);

                if (data.success) {
                    // ç›´æ¥æ˜¾ç¤ºæ–‡ä»¶ï¼Œæ— åŠ è½½åŠ¨ç”»
                    displayFiles('targetFileBrowser', data.files, targetPath, false);
                    addLogInfo(`ğŸ“‚ å·²è¿›å…¥ç›®æ ‡ç›®å½•: ${targetPath} (${data.files.length}é¡¹) - ${(endTime - startTime).toFixed(0)}ms`);
                } else {
                    showErrorState('targetFileBrowser', 'æµè§ˆå¤±è´¥: ' + data.error);
                    addLogError(`âŒ æµè§ˆç›®æ ‡ç›®å½•å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    showErrorState('targetFileBrowser', 'æµè§ˆå¤±è´¥: ' + error.message);
                    addLogError(`âŒ æµè§ˆç›®æ ‡ç›®å½•å‡ºé”™: ${error}`);
                }
            }
        }

        // åˆ·æ–°ç›®æ ‡æ–‡ä»¶ - å¼ºåˆ¶æ¸…é™¤ç¼“å­˜ç‰ˆæœ¬ï¼ˆæ— åŠ è½½åŠ¨ç”»ï¼‰
        async function refreshTargetAsync() {
            const server = document.getElementById('targetServer').value;
            const path = document.getElementById('targetPath').value;
            const showHidden = document.getElementById('targetShowHidden').checked;

            if (!server) {
                alert('è¯·å…ˆé€‰æ‹©ç›®æ ‡æœåŠ¡å™¨');
                return;
            }

            try {
                // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
                if (window.targetRefreshController) {
                    window.targetRefreshController.abort();
                }
                window.targetRefreshController = new AbortController();

                // å‘èµ·å¼ºåˆ¶åˆ·æ–°è¯·æ±‚
                const startTime = performance.now();
                console.log(`[ç›®æ ‡æ–‡ä»¶åˆ·æ–°] å¼ºåˆ¶åˆ·æ–°: ${path}`);

                const response = await fetch(`/api/browse/${server}?path=${encodeURIComponent(path)}&show_hidden=${showHidden}&force_refresh=true`, {
                    signal: window.targetRefreshController.signal,
                    // å¼ºåˆ¶åˆ·æ–°ä¸ä½¿ç”¨ç¼“å­˜
                    cache: 'no-cache'
                });

                const data = await response.json();
                const endTime = performance.now();
                console.log(`[ç›®æ ‡æ–‡ä»¶åˆ·æ–°] åˆ·æ–°å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);

                if (data.success) {
                    // ç›´æ¥æ˜¾ç¤ºæ–‡ä»¶ï¼Œæ— åŠ è½½åŠ¨ç”»
                    displayFiles('targetFileBrowser', data.files, path, false);
                    const cacheInfo = data.cache_cleared > 0 ? ` (æ¸…é™¤${data.cache_cleared}ä¸ªç¼“å­˜)` : '';
                    addLogSuccess(`ğŸ”„ å·²åˆ·æ–°ç›®æ ‡ç›®å½•: ${path} (${data.files.length}é¡¹) - ${(endTime - startTime).toFixed(0)}ms${cacheInfo}`);
                } else {
                    showErrorState('targetFileBrowser', 'åˆ·æ–°å¤±è´¥: ' + data.error);
                    addLogError(`âŒ åˆ·æ–°ç›®æ ‡ç›®å½•å¤±è´¥: ${data.error}`);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    showErrorState('targetFileBrowser', 'åˆ·æ–°å¤±è´¥: ' + error.message);
                    addLogError(`âŒ åˆ·æ–°ç›®æ ‡ç›®å½•å‡ºé”™: ${error}`);
                }
            }
        }

        // åˆ‡æ¢éšè—æ–‡ä»¶æ˜¾ç¤º
        function toggleHiddenFiles(type) {
            if (type === 'source') {
                const server = document.getElementById('sourceServer').value;
                const path = document.getElementById('sourcePath').value;
                if (server && path) {
                    browseSource();
                }
            } else if (type === 'target') {
                const server = document.getElementById('targetServer').value;
                const path = document.getElementById('targetPath').value;
                if (server && path) {
                    browseTarget();
                }
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFiles(containerId, files, currentPath, isSource) {
            const container = document.getElementById(containerId);
            let html = '';

            // æ›´æ–°è·¯å¾„å¯¼èˆª
            updatePathNavigation(currentPath, isSource);

            // è¿”å›ä¸Šçº§ç›®å½• - ä¿®æ”¹ä¸ºåŒå‡»æ“ä½œ
            if (currentPath !== '/') {
                const parentPath = currentPath.split('/').slice(0, -1).join('/') || '/';
                html += `<div class="file-item" ondblclick="navigateTo('${containerId}', '${parentPath}', ${isSource})" title="åŒå‡»è¿”å›ä¸Šçº§ç›®å½•">
                    <i class="bi bi-arrow-up-circle text-primary"></i>
                    <div class="file-info">
                        <span class="file-name">..</span>
                        <span class="file-details" style="font-size: 0.75rem; color: #6c757d;">åŒå‡»è¿”å›ä¸Šçº§</span>
                    </div>
                </div>`;
            }

            // æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
            files.forEach((file, index) => {
                const icon = file.is_directory ? 'bi-folder-fill text-warning' : 'bi-file-earmark text-info';
                const size = file.is_directory ? '' : formatFileSize(file.size);
                const fileId = `file_${containerId}_${index}`;

                if (isSource) {
                    // æºæ–‡ä»¶æ”¯æŒå¤šé€‰ã€åŒå‡»è¿›å…¥ç›®å½•å’Œæ‹–æ‹½ - ä¼˜åŒ–äº‹ä»¶å¤„ç†
                    html += `<div class="file-item selectable" id="${fileId}"
                             draggable="true"
                             data-path="${file.path}"
                             data-name="${file.name}"
                             data-is-directory="${file.is_directory}"
                             onmousedown="handleFileMouseDown(event, '${file.path}', '${file.name}', ${file.is_directory}, '${fileId}', ${isSource})"
                             ondragstart="handleDragStart(event)"
                             ondragend="handleDragEnd(event)">
                        <i class="bi ${icon}"></i>
                        <div class="file-info">
                            <span class="file-name">${file.name}</span>
                            <span class="file-details">${size} ${file.modified}</span>
                        </div>
                    </div>`;
                } else {
                    // ç›®æ ‡ç›®å½•åªæ”¯æŒå¯¼èˆª - ä¼˜åŒ–äº‹ä»¶å¤„ç†
                    html += `<div class="file-item"
                             onmousedown="handleFileMouseDown(event, '${file.path}', '${file.name}', ${file.is_directory}, null, ${isSource})">
                        <i class="bi ${icon}"></i>
                        <div class="file-info">
                            <span class="file-name">${file.name}</span>
                            <span class="file-details">${size} ${file.modified}</span>
                        </div>
                    </div>`;
                }
            });

            // æ·»åŠ åº•éƒ¨é—´è·ç¡®ä¿æœ€åä¸€ä¸ªæ–‡ä»¶å¯è§
            html += '<div style="height: 20px;"></div>';

            container.innerHTML = html;

            // ä¸ºç›®æ ‡æ–‡ä»¶æµè§ˆå™¨æ·»åŠ æ‹–æ‹½æ¥æ”¶åŠŸèƒ½
            if (!isSource) {
                setupDropZone(container);
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
        }

        // å¯¼èˆªåˆ°ç›®å½•ï¼ˆæ— åŠ è½½åŠ¨ç”»ç‰ˆæœ¬ï¼‰
        function navigateTo(containerId, path, isSource) {
            if (isSource) {
                document.getElementById('sourcePath').value = path;
                // ç›´æ¥ä½¿ç”¨å³æ—¶æµè§ˆï¼Œæ— åŠ è½½åŠ¨ç”»
                browseSourceInstant(path);
            } else {
                document.getElementById('targetPath').value = path;
                // ç›´æ¥ä½¿ç”¨å³æ—¶æµè§ˆï¼Œæ— åŠ è½½åŠ¨ç”»
                browseTargetInstant(path);
            }
        }

        // æ™ºèƒ½é¼ æ ‡äº‹ä»¶å¤„ç† - åŒºåˆ†å•å‡»å’ŒåŒå‡»ï¼ˆæ— åŠ è½½åŠ¨ç”»ç‰ˆæœ¬ï¼‰
        let clickTimer = null;
        let clickCount = 0;

        function handleFileMouseDown(event, path, name, isDirectory, fileId, isSource) {
            event.preventDefault();
            clickCount++;

            if (clickCount === 1) {
                // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œè®¾ç½®å»¶è¿Ÿå¤„ç†å•å‡»
                clickTimer = setTimeout(() => {
                    // å•å‡»å¤„ç†
                    if (isSource && fileId) {
                        selectFile(event, path, name, isDirectory, fileId);
                    }
                    clickCount = 0;
                }, 200); // 200mså»¶è¿Ÿï¼Œç­‰å¾…å¯èƒ½çš„ç¬¬äºŒæ¬¡ç‚¹å‡»
            } else if (clickCount === 2) {
                // åŒå‡»å¤„ç† - ç«‹å³å“åº”ï¼Œæ— åŠ è½½åŠ¨ç”»
                clearTimeout(clickTimer);
                clickCount = 0;

                if (isDirectory) {
                    // ç«‹å³å“åº”åŒå‡»ï¼Œæ— å»¶è¿Ÿï¼Œæ— åŠ è½½åŠ¨ç”»
                    console.log(`[åŒå‡»] ç«‹å³è¿›å…¥ç›®å½•: ${path}`);

                    // ç«‹å³æ›´æ–°è·¯å¾„
                    if (isSource) {
                        document.getElementById('sourcePath').value = path;
                        // ç›´æ¥å¼€å§‹å¼‚æ­¥åŠ è½½ï¼Œä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        browseSourceInstant(path);
                    } else {
                        document.getElementById('targetPath').value = path;
                        // ç›´æ¥å¼€å§‹å¼‚æ­¥åŠ è½½ï¼Œä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        browseTargetInstant(path);
                    }
                }
            }
        }

        // å¤„ç†åŒå‡»äº‹ä»¶ - ä¿æŒå…¼å®¹æ€§ï¼ˆæ— åŠ è½½åŠ¨ç”»ç‰ˆæœ¬ï¼‰
        function handleDoubleClick(path, isDirectory, isSource) {
            if (!isDirectory) return;

            // ç«‹å³å“åº”ï¼Œæ— å»¶è¿Ÿï¼Œæ— åŠ è½½åŠ¨ç”»
            console.log(`[åŒå‡»] ç«‹å³è¿›å…¥ç›®å½•: ${path}`);

            // ç«‹å³æ›´æ–°è·¯å¾„
            if (isSource) {
                document.getElementById('sourcePath').value = path;
                // ç›´æ¥å¼€å§‹å¼‚æ­¥åŠ è½½ï¼Œä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                browseSourceInstant(path);
            } else {
                document.getElementById('targetPath').value = path;
                // ç›´æ¥å¼€å§‹å¼‚æ­¥åŠ è½½ï¼Œä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                browseTargetInstant(path);
            }
        }

        // æ³¨æ„ï¼šåŠ è½½åŠ¨ç”»ç›¸å…³å‡½æ•°å·²ç§»é™¤ï¼Œå®ç°æ— æ„ŸåŒå‡»è¿›å…¥æ–‡ä»¶å¤¹

        // åˆ·æ–°çŠ¶æ€å‡½æ•°å·²ç§»é™¤ï¼Œå®ç°æ— æ„Ÿåˆ·æ–°

        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        function showErrorState(containerId, errorMessage) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="text-danger mb-3">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem;"></i>
                    </div>
                    <div class="text-danger">${errorMessage}</div>
                    <button class="btn btn-outline-primary btn-sm mt-3" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> é‡æ–°åŠ è½½
                    </button>
                </div>
            `;
        }

        // é˜²æŠ–å‡½æ•° - é˜²æ­¢å¿«é€Ÿé‡å¤æ“ä½œ
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ä¼˜åŒ–çš„åŒå‡»å¤„ç† - æ·»åŠ é˜²æŠ–ï¼ˆæ— åŠ è½½åŠ¨ç”»ç‰ˆæœ¬ï¼‰
        const debouncedHandleDoubleClick = debounce(function(path, isDirectory, isSource) {
            if (isDirectory) {
                // ç«‹å³æ›´æ–°è·¯å¾„æ˜¾ç¤ºï¼Œæä¾›å³æ—¶åé¦ˆ
                if (isSource) {
                    document.getElementById('sourcePath').value = path;
                    // ç›´æ¥å¼‚æ­¥æµè§ˆç›®å½•ï¼Œæ— åŠ è½½åŠ¨ç”»
                    browseSourceAsync();
                } else {
                    document.getElementById('targetPath').value = path;
                    // ç›´æ¥å¼‚æ­¥æµè§ˆç›®å½•ï¼Œæ— åŠ è½½åŠ¨ç”»
                    browseTargetAsync();
                }
            }
        }, 100); // 100msé˜²æŠ–å»¶è¿Ÿ

        // æ›´æ–°è·¯å¾„å¯¼èˆª
        function updatePathNavigation(currentPath, isSource) {
            const navId = isSource ? 'sourcePathNav' : 'targetPathNav';
            const displayId = isSource ? 'sourcePathDisplay' : 'targetPathDisplay';
            const nav = document.getElementById(navId);
            const display = document.getElementById(displayId);

            if (currentPath && currentPath !== '/') {
                nav.style.display = 'block';
                const pathParts = currentPath.split('/').filter(part => part);
                let html = '<a href="#" class="path-segment" onclick="navigateToPath(\'/\', ' + isSource + ')">æ ¹ç›®å½•</a>';

                let buildPath = '';
                pathParts.forEach((part, index) => {
                    buildPath += '/' + part;
                    html += '<span class="path-separator">/</span>';
                    html += `<a href="#" class="path-segment" onclick="navigateToPath('${buildPath}', ${isSource})">${part}</a>`;
                });

                display.innerHTML = html;
            } else {
                nav.style.display = 'block';
                display.innerHTML = '<span class="path-segment">æ ¹ç›®å½•</span>';
            }
        }

        // å¯¼èˆªåˆ°æŒ‡å®šè·¯å¾„ï¼ˆæ— åŠ è½½åŠ¨ç”»ç‰ˆæœ¬ï¼‰
        function navigateToPath(path, isSource) {
            if (isSource) {
                document.getElementById('sourcePath').value = path;
                // ç›´æ¥ä½¿ç”¨å³æ—¶æµè§ˆï¼Œæ— åŠ è½½åŠ¨ç”»
                browseSourceInstant(path);
            } else {
                document.getElementById('targetPath').value = path;
                // ç›´æ¥ä½¿ç”¨å³æ—¶æµè§ˆï¼Œæ— åŠ è½½åŠ¨ç”»
                browseTargetInstant(path);
            }
        }

        // é€‰æ‹©æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
        function selectFile(event, path, name, isDirectory, fileId) {
            event.stopPropagation();

            const fileElement = document.getElementById(fileId);

            if (event.ctrlKey || event.metaKey) {
                // Ctrl+ç‚¹å‡»å¤šé€‰
                if (fileElement.classList.contains('selected')) {
                    selectedSourceFiles = selectedSourceFiles.filter(f => f.path !== path);
                    fileElement.classList.remove('selected');
                } else {
                    selectedSourceFiles.push({path, name, is_directory: isDirectory});
                    fileElement.classList.add('selected');
                }
            } else {
                // å•é€‰
                clearAllSelections();
                fileElement.classList.add('selected');
                selectedSourceFiles = [{path, name, is_directory: isDirectory}];
            }

            updateSelectionInfo();
        }

        // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
        function clearAllSelections() {
            selectedSourceFiles = [];
            document.querySelectorAll('.file-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // æ›´æ–°é€‰æ‹©ä¿¡æ¯
        function updateSelectionInfo() {
            if (selectedSourceFiles.length > 0) {
                const names = selectedSourceFiles.map(f => f.name).join(', ');
                addLog(`å·²é€‰æ‹© ${selectedSourceFiles.length} é¡¹: ${names}`);
            }
        }

        // æ‹–æ‹½å¼€å§‹
        function handleDragStart(event) {
            const fileElement = event.target.closest('.file-item');
            const path = fileElement.dataset.path;
            const name = fileElement.dataset.name;
            const isDirectory = String(fileElement.dataset.isDirectory).toLowerCase() === 'true';

            // å¦‚æœæ‹–æ‹½çš„æ–‡ä»¶æ²¡æœ‰è¢«é€‰ä¸­ï¼Œåˆ™é€‰ä¸­å®ƒ
            if (!fileElement.classList.contains('selected')) {
                clearAllSelections();
                fileElement.classList.add('selected');
                selectedSourceFiles = [{path, name, is_directory: isDirectory}];
            }

            // è®¾ç½®æ‹–æ‹½æ•°æ®
            event.dataTransfer.setData('text/plain', JSON.stringify(selectedSourceFiles));
            event.dataTransfer.effectAllowed = 'copy';

            // åˆ›å»ºæ‹–æ‹½é¢„è§ˆ
            const dragPreview = document.createElement('div');
            dragPreview.className = 'drag-preview';
            dragPreview.textContent = selectedSourceFiles.length > 1
                ? `${selectedSourceFiles.length} ä¸ªé¡¹ç›®`
                : name;
            document.body.appendChild(dragPreview);

            // è®¾ç½®æ‹–æ‹½å›¾åƒ
            event.dataTransfer.setDragImage(dragPreview, 10, 10);

            // å»¶è¿Ÿç§»é™¤é¢„è§ˆå…ƒç´ 
            setTimeout(() => {
                if (document.body.contains(dragPreview)) {
                    document.body.removeChild(dragPreview);
                }
            }, 0);

            fileElement.classList.add('dragging');
        }

        // æ‹–æ‹½ç»“æŸ
        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.file-browser.drag-over').forEach(browser => {
                browser.classList.remove('drag-over');
            });
        }

        // è®¾ç½®æ‹–æ”¾åŒºåŸŸ
        function setupDropZone(container) {
            container.addEventListener('dragover', function(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
                container.classList.add('drag-over');
            });

            container.addEventListener('dragleave', function(event) {
                if (!container.contains(event.relatedTarget)) {
                    container.classList.remove('drag-over');
                }
            });

            container.addEventListener('drop', function(event) {
                event.preventDefault();
                container.classList.remove('drag-over');

                try {
                    const draggedFiles = JSON.parse(event.dataTransfer.getData('text/plain'));
                    if (draggedFiles && draggedFiles.length > 0) {
                        // è‡ªåŠ¨å¼€å§‹ä¼ è¾“
                        selectedSourceFiles = draggedFiles;
                        startTransferFromDrag();
                    }
                } catch (e) {
                    console.error('æ‹–æ‹½æ•°æ®è§£æå¤±è´¥:', e);
                }
            });
        }

        // ä»æ‹–æ‹½å¼€å§‹ä¼ è¾“
        function startTransferFromDrag() {
            const sourceServer = document.getElementById('sourceServer').value;
            const targetServer = document.getElementById('targetServer').value;
            const targetPath = document.getElementById('targetPath').value;

            if (!sourceServer || !targetServer || !targetPath) {
                alert('è¯·ç¡®ä¿å·²é€‰æ‹©æºæœåŠ¡å™¨ã€ç›®æ ‡æœåŠ¡å™¨å’Œç›®æ ‡è·¯å¾„');
                return;
            }

            addLog('é€šè¿‡æ‹–æ‹½å¼€å§‹ä¼ è¾“...');
            startTransfer();
        }

        // å¼€å§‹ä¼ è¾“
        function startTransfer() {
            const sourceServer = document.getElementById('sourceServer').value;
            const targetServer = document.getElementById('targetServer').value;
            const targetPath = document.getElementById('targetPath').value;
            const mode = document.getElementById('transferMode').value;
            const fastSSH = document.getElementById('fastSSH').checked;
            const parallelTransfer = document.getElementById('parallelTransfer').checked;

            if (!sourceServer || !targetServer || !targetPath) {
                addLogWarning('âš ï¸ è¯·é€‰æ‹©æºæœåŠ¡å™¨ã€ç›®æ ‡æœåŠ¡å™¨å’Œç›®æ ‡è·¯å¾„');
                alert('è¯·é€‰æ‹©æºæœåŠ¡å™¨ã€ç›®æ ‡æœåŠ¡å™¨å’Œç›®æ ‡è·¯å¾„');
                return;
            }

            if (selectedSourceFiles.length === 0) {
                addLogWarning('âš ï¸ è¯·é€‰æ‹©è¦ä¼ è¾“çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹');
                alert('è¯·é€‰æ‹©è¦ä¼ è¾“çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹');
                return;
            }

            if (sourceServer === targetServer) {
                // æ£€æŸ¥æ˜¯å¦æœ‰è·¯å¾„å†²çª
                const hasConflict = selectedSourceFiles.some(file =>
                    file.path === targetPath || targetPath.startsWith(file.path + '/')
                );
                if (hasConflict) {
                    addLogWarning('âš ï¸ æºè·¯å¾„å’Œç›®æ ‡è·¯å¾„ä¸èƒ½ç›¸åŒæˆ–å­˜åœ¨åŒ…å«å…³ç³»');
                    alert('æºè·¯å¾„å’Œç›®æ ‡è·¯å¾„ä¸èƒ½ç›¸åŒæˆ–å­˜åœ¨åŒ…å«å…³ç³»');
                    return;
                }
            }

            // è®¾ç½®ä¼ è¾“çŠ¶æ€
            isTransferring = true;

            // æ˜¾ç¤ºè¿›åº¦é¢æ¿
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('startTransferBtn').style.display = 'none';
            document.getElementById('cancelTransferBtn').style.display = 'inline-block';

            const fileNames = selectedSourceFiles.map(f => f.name).join(', ');
            const modeText = mode === 'copy' ? 'å¤åˆ¶' : 'ç§»åŠ¨';
            const sshText = fastSSH ? '(SSHåŠ é€Ÿ)' : '';
            const parallelText = parallelTransfer ? '(ç«‹å³å¹¶è¡Œä¼ è¾“)' : '';

            addLogInfo(`ğŸš€ å¼€å§‹${modeText}ä¼ è¾“ ${sshText}${parallelText}`);
            addLogInfo(`ğŸ“¤ æº: ${sourceServer} (${selectedSourceFiles.length}é¡¹)`);
            addLogInfo(`ğŸ“¥ ç›®æ ‡: ${targetServer}:${targetPath}`);
            addLogInfo(`ğŸ“‹ æ–‡ä»¶: ${fileNames.length > 50 ? fileNames.substring(0, 50) + '...' : fileNames}`);

            // å‘é€ä¼ è¾“è¯·æ±‚
            socket.emit('start_transfer', {
                source_server: sourceServer,
                source_files: selectedSourceFiles,
                target_server: targetServer,
                target_path: targetPath,
                mode: mode,
                fast_ssh: fastSSH,
                parallel_transfer: parallelTransfer
            });
        }

        // å–æ¶ˆä¼ è¾“
        function cancelTransfer() {
            if (currentTransferId) {
                // ç«‹å³æ›´æ–°UIçŠ¶æ€ï¼Œä¸ç­‰å¾…ç¡®è®¤
                addLogWarning('ğŸ›‘ ç”¨æˆ·è¯·æ±‚å–æ¶ˆä¼ è¾“...');

                // ç«‹å³ç¦ç”¨å–æ¶ˆæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
                const cancelBtn = document.getElementById('cancelTransferBtn');
                cancelBtn.disabled = true;
                cancelBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> å–æ¶ˆä¸­...';

                // ç«‹å³å‘é€å–æ¶ˆè¯·æ±‚ï¼Œä¸éœ€è¦ç¡®è®¤å¯¹è¯æ¡†
                socket.emit('cancel_transfer', {
                    transfer_id: currentTransferId
                });

                // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼Œå¦‚æœ3ç§’å†…æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œå¼ºåˆ¶é‡ç½®UI
                setTimeout(() => {
                    if (cancelBtn.disabled) {
                        addLogWarning('âš ï¸ å–æ¶ˆæ“ä½œè¶…æ—¶ï¼Œå¼ºåˆ¶é‡ç½®ç•Œé¢');
                        resetTransferUI();
                        isTransferring = false;
                    }
                }, 3000);
            }
        }

        // å¼ºåˆ¶å–æ¶ˆä¼ è¾“ï¼ˆåŒå‡»è§¦å‘ï¼‰
        function forceCancelTransfer() {
            if (currentTransferId) {
                addLogError('ğŸš¨ å¼ºåˆ¶ç»ˆæ­¢ä¼ è¾“...');

                // ç«‹å³é‡ç½®UI
                resetTransferUI();
                isTransferring = false;

                // å‘é€å¼ºåˆ¶å–æ¶ˆè¯·æ±‚
                socket.emit('cancel_transfer', {
                    transfer_id: currentTransferId,
                    force: true
                });

                // æ¸…é™¤å½“å‰ä¼ è¾“ID
                currentTransferId = null;
            }
        }

        // é‡ç½®ä¼ è¾“ç•Œé¢
        function resetTransferUI() {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('startTransferBtn').style.display = 'inline-block';

            // é‡ç½®å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.getElementById('cancelTransferBtn');
            cancelBtn.style.display = 'none';
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '<i class="bi bi-stop-circle-fill"></i> å–æ¶ˆ';

            // é‡ç½®ä¼ è¾“è·¯å¾„æ˜¾ç¤º
            document.getElementById('transferRoute').innerHTML = '<i class="bi bi-arrow-right-circle-fill me-1"></i>å‡†å¤‡ä¼ è¾“...';

            // é‡ç½®çŠ¶æ€ä¿¡æ¯
            document.getElementById('transferStatus').textContent = 'å‡†å¤‡ä¸­';
            document.getElementById('transferSpeed').textContent = '-';
            document.getElementById('transferredBytes').textContent = '-';
            document.getElementById('eta').textContent = '-';

            currentTransferId = null;
        }

        // WebSocketäº‹ä»¶å¤„ç†
        socket.on('transfer_started', function(data) {
            isTransferring = true;
            currentTransferId = data.transfer_id;
            window.transferModeLogged = false; // é‡ç½®ä¼ è¾“æ¨¡å¼æ—¥å¿—æ ‡å¿—
            document.getElementById('transferStatus').textContent = 'ä¼ è¾“ä¸­...';
            addLogSuccess(`âœ… ä¼ è¾“ä»»åŠ¡å·²å¯åŠ¨ (ID: ${data.transfer_id})`);
        });

        socket.on('transfer_progress', function(data) {
            if (data.transfer_id === currentTransferId) {
                const progress = data.progress;

                // æ›´æ–°ä¼ è¾“è·¯å¾„æ˜¾ç¤º
                if (progress.source_server && progress.target_server) {
                    const sourceDisplay = progress.source_server === 'localhost' ? 'æœ¬åœ°' : progress.source_server;
                    const targetDisplay = progress.target_server === 'localhost' ? 'æœ¬åœ°' : progress.target_server;

                    let routeIcon = 'ğŸ”„';
                    if (progress.transfer_mode === 'local_to_remote') {
                        routeIcon = 'ğŸ“¤';
                    } else if (progress.transfer_mode === 'remote_to_local') {
                        routeIcon = 'ğŸ“¥';
                    }

                    document.getElementById('transferRoute').innerHTML =
                        `${routeIcon} ${sourceDisplay} â†’ ${targetDisplay}`;
                }

                // æ›´æ–°çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…å«ä¼ è¾“æ¨¡å¼
                let statusText = '';
                let modeIcon = '';

                // æ ¹æ®ä¼ è¾“æ¨¡å¼è®¾ç½®å›¾æ ‡
                if (progress.transfer_mode) {
                    switch (progress.transfer_mode) {
                        case 'local_to_remote':
                            modeIcon = 'ğŸ“¤';
                            break;
                        case 'remote_to_local':
                            modeIcon = 'ğŸ“¥';
                            break;
                        case 'remote_to_remote':
                            modeIcon = 'ğŸ”„';
                            break;
                        default:
                            modeIcon = 'ğŸ“';
                    }
                }

                if (progress.current_file) {
                    statusText = `${modeIcon} ä¼ è¾“ä¸­: ${progress.current_file}`;
                    if (progress.completed_files !== undefined && progress.total_files !== undefined) {
                        statusText += ` (${progress.completed_files}/${progress.total_files})`;
                    }

                    // æ·»åŠ æœåŠ¡å™¨ä¿¡æ¯
                    if (progress.source_server && progress.target_server) {
                        const sourceDisplay = progress.source_server === 'localhost' ? 'æœ¬åœ°' : progress.source_server;
                        const targetDisplay = progress.target_server === 'localhost' ? 'æœ¬åœ°' : progress.target_server;
                        statusText += ` [${sourceDisplay}â†’${targetDisplay}]`;
                    }

                    document.getElementById('transferStatus').textContent = statusText;
                } else if (progress.files_transferred && progress.total_files) {
                    document.getElementById('transferStatus').textContent =
                        `${modeIcon} ä¼ è¾“ä¸­: ${progress.files_transferred}/${progress.total_files} æ–‡ä»¶`;
                }

                // æ›´æ–°ä¼ è¾“é€Ÿåº¦
                if (progress.speed) {
                    document.getElementById('transferSpeed').textContent = progress.speed;
                }

                // æ›´æ–°å·²ä¼ è¾“å­—èŠ‚æ•° - æ˜¾ç¤ºä¸º"ä¼ è¾“ä¸­..."
                document.getElementById('transferredBytes').textContent = 'ä¼ è¾“ä¸­...';

                // æ›´æ–°å·²ç”¨æ—¶é—´
                if (progress.elapsed_time) {
                    document.getElementById('elapsedTime').textContent = progress.elapsed_time;
                }

                // å¦‚æœæœ‰æ¶ˆæ¯ï¼Œä¹Ÿæ·»åŠ åˆ°æ—¥å¿—
                if (progress.message) {
                    addLog(progress.message);
                }

                // é¦–æ¬¡æ˜¾ç¤ºä¼ è¾“æ¨¡å¼ä¿¡æ¯
                if (progress.transfer_mode && !window.transferModeLogged) {
                    let modeDescription = '';
                    switch (progress.transfer_mode) {
                        case 'local_to_remote':
                            modeDescription = 'æœ¬åœ°åˆ°è¿œç¨‹ä¼ è¾“';
                            break;
                        case 'remote_to_local':
                            modeDescription = 'è¿œç¨‹åˆ°æœ¬åœ°ä¼ è¾“';
                            break;
                        case 'remote_to_remote':
                            modeDescription = 'è¿œç¨‹åˆ°è¿œç¨‹ä¼ è¾“';
                            break;
                        default:
                            modeDescription = 'æœ¬åœ°ä¼ è¾“';
                    }

                    if (progress.source_server && progress.target_server) {
                        const sourceDisplay = progress.source_server === 'localhost' ? 'æœ¬åœ°' : progress.source_server;
                        const targetDisplay = progress.target_server === 'localhost' ? 'æœ¬åœ°' : progress.target_server;
                        addLogInfo(`ğŸ”„ ä¼ è¾“æ¨¡å¼: ${modeDescription} (${sourceDisplay} â†’ ${targetDisplay})`);
                    }

                    window.transferModeLogged = true;
                }
            }
        });

        socket.on('transfer_log', function(data) {
            if (data.transfer_id === currentTransferId) {
                // ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ—¥å¿—ä½¿ç”¨infoçº§åˆ«ï¼Œä½†ä¼šè¢«è¿‡æ»¤
                addLogInfo(data.message);
            }
        });

        // ç›‘å¬é€Ÿåº¦æ›´æ–°äº‹ä»¶ï¼ˆ10msé«˜é¢‘æ›´æ–°ï¼‰
        socket.on('speed_update', function(data) {
            if (data.transfer_id === currentTransferId) {
                // æ›´æ–°ä¼ è¾“é€Ÿåº¦ï¼ˆæ¯10msï¼‰
                if (data.speed) {
                    document.getElementById('transferSpeed').textContent = data.speed;
                }

                // æ›´æ–°å·²ç”¨æ—¶é—´ï¼ˆä»…å½“æœ‰æ–°æ—¶é—´æ•°æ®æ—¶ï¼‰
                if (data.elapsed_time) {
                    document.getElementById('elapsedTime').textContent = data.elapsed_time;
                }

                // æ›´æ–°ä¼ è¾“è·¯å¾„æ˜¾ç¤ºï¼ˆä»…åœ¨é¦–æ¬¡æˆ–å˜åŒ–æ—¶ï¼‰
                if (data.source_server && data.target_server) {
                    const sourceDisplay = data.source_server === 'localhost' ? 'æœ¬åœ°' : data.source_server;
                    const targetDisplay = data.target_server === 'localhost' ? 'æœ¬åœ°' : data.target_server;

                    let routeIcon = 'ğŸ”„';
                    if (data.transfer_mode === 'local_to_remote') {
                        routeIcon = 'ğŸ“¤';
                    } else if (data.transfer_mode === 'remote_to_local') {
                        routeIcon = 'ğŸ“¥';
                    }

                    const newRoute = `${routeIcon} ${sourceDisplay} â†’ ${targetDisplay}`;
                    const currentRoute = document.getElementById('transferRoute').innerHTML;

                    // åªåœ¨è·¯å¾„å˜åŒ–æ—¶æ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„DOMæ“ä½œ
                    if (currentRoute !== newRoute) {
                        document.getElementById('transferRoute').innerHTML = newRoute;
                    }
                }
            }
        });

        socket.on('transfer_complete', function(data) {
            if (data.transfer_id === currentTransferId) {
                // ä¼ è¾“ç»“æŸï¼Œæ¢å¤æ—¥å¿—è®°å½•
                isTransferring = false;

                if (data.status === 'success') {
                    document.getElementById('transferStatus').textContent = 'ä¼ è¾“å®Œæˆ';
                    document.getElementById('transferRoute').innerHTML = '<i class="bi bi-check-circle-fill text-success me-1"></i>ä¼ è¾“å®Œæˆ';

                    // æ˜¾ç¤ºæ€»è€—æ—¶
                    if (data.total_time) {
                        document.getElementById('elapsedTime').textContent = data.total_time;
                    }

                    addLogSuccess('ğŸ‰ ä¼ è¾“æˆåŠŸå®Œæˆ');

                    // è®°å½•ä¼ è¾“ç»Ÿè®¡ä¿¡æ¯
                    if (data.stats) {
                        addLogInfo(`ğŸ“Š ä¼ è¾“ç»Ÿè®¡: ${data.stats.files_transferred || 0}ä¸ªæ–‡ä»¶, ${data.stats.total_size || 'æœªçŸ¥'}å¤§å°`);
                        addLogInfo(`â±ï¸ ä¼ è¾“è€—æ—¶: ${data.stats.duration || 'æœªçŸ¥'}`);
                    }

                    // è‡ªåŠ¨åˆ·æ–°ç›®æ ‡ç›®å½•ï¼Œæ˜¾ç¤ºæœ€æ–°ä¼ è¾“çš„æ–‡ä»¶
                    setTimeout(() => {
                        const targetServer = document.getElementById('targetServer').value;
                        const targetPath = document.getElementById('targetPath').value;

                        if (targetServer && targetPath) {
                            addLogInfo('ğŸ”„ è‡ªåŠ¨åˆ·æ–°ç›®æ ‡ç›®å½•ä»¥æ˜¾ç¤ºæœ€æ–°æ–‡ä»¶...');
                            refreshTargetAsync();
                        }
                    }, 1000); // å»¶è¿Ÿ1ç§’ååˆ·æ–°ï¼Œç¡®ä¿æ–‡ä»¶ç³»ç»ŸåŒæ­¥
                } else {
                    document.getElementById('transferStatus').textContent = 'ä¼ è¾“å¤±è´¥';
                    document.getElementById('progressBar').classList.add('bg-danger');
                    addLogError(`âŒ ä¼ è¾“å¤±è´¥: ${data.message}`);
                }

                setTimeout(resetTransferUI, 3000);
            }
        });

        // å¤„ç†å–æ¶ˆä¼ è¾“å“åº”
        socket.on('transfer_cancelled', function(data) {
            if (data.transfer_id === currentTransferId) {
                // ä¼ è¾“å–æ¶ˆï¼Œæ¢å¤æ—¥å¿—è®°å½•
                isTransferring = false;

                if (data.status === 'success') {
                    document.getElementById('transferStatus').textContent = 'ä¼ è¾“å·²å–æ¶ˆ';
                    document.getElementById('progressBar').classList.remove('progress-bar-animated');
                    document.getElementById('progressBar').classList.add('bg-warning');
                    addLogWarning('âš ï¸ ä¼ è¾“å·²å–æ¶ˆ');
                } else {
                    addLogError(`âŒ å–æ¶ˆä¼ è¾“å¤±è´¥: ${data.message}`);
                }

                setTimeout(resetTransferUI, 2000);
            }
        });

        // åˆå§‹åŒ–é¢æ¿è°ƒæ•´åŠŸèƒ½
        function initializeResizers() {
            // å‚ç›´åˆ†éš”æ¡ï¼ˆå·¦å³é¢æ¿ï¼‰
            const verticalResizer = document.getElementById('verticalResizer');
            const sourcePanel = document.getElementById('sourcePanel');
            const targetPanel = document.getElementById('targetPanel');

            let isResizing = false;

            verticalResizer.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.addEventListener('mousemove', handleVerticalResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });

            function handleVerticalResize(e) {
                if (!isResizing) return;

                const container = verticalResizer.parentElement;
                const containerRect = container.getBoundingClientRect();
                const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;

                if (percentage > 20 && percentage < 80) {
                    sourcePanel.style.width = percentage + '%';
                    targetPanel.style.width = (100 - percentage) + '%';
                }
            }

            // æ°´å¹³åˆ†éš”æ¡å·²ç§»é™¤

            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleVerticalResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // æ ¹æ®æœåŠ¡å™¨IPè·å–é»˜è®¤è·¯å¾„
        function getDefaultPath(serverIP) {
            const serverPaths = {
                '192.168.9.62': '/home/th',
                '192.168.9.61': '/home/th',
                '192.168.9.60': '/home/th',
                '192.168.9.57': '/home/thgd'
            };
            return serverPaths[serverIP] || '/home/th';
        }

        // LOGOæ˜¾ç¤ºæ–¹æ¡ˆåˆ‡æ¢å‡½æ•°ï¼ˆä¿ç•™å¤‡ç”¨ï¼‰
        function switchLogoDisplay(mode) {
            // å½“å‰ä½¿ç”¨æ–¹æ¡ˆä¸€ï¼ˆæ ‡é¢˜å¹¶æ’ï¼‰ï¼Œå…¶ä»–æ–¹æ¡ˆå·²éšè—
            console.log(`LOGOæ˜¾ç¤ºæ¨¡å¼: ${mode === 'header' ? 'æ ‡é¢˜å¹¶æ’ï¼ˆå½“å‰ï¼‰' : mode}`);
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLogInfo('ğŸš€ TurboFile æé€Ÿä¼ æ–‡ä»¶ä¼ è¾“ç³»ç»Ÿå·²å¯åŠ¨');
            addLogInfo('ğŸ“‹ è¯·é€‰æ‹©æºæœåŠ¡å™¨å’Œç›®æ ‡æœåŠ¡å™¨å¼€å§‹ä¼ è¾“');
            addLogInfo('ğŸ’¡ æç¤º: ä¼ è¾“è¿‡ç¨‹ä¸­è¯¦ç»†è¿›åº¦ä¿¡æ¯å°†ä¸åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºä»¥ä¿æŒæœ€ä½³æ€§èƒ½');

            // é»˜è®¤ä½¿ç”¨æ ‡é¢˜å¹¶æ’æ¨¡å¼ï¼Œæ‚¨å¯ä»¥è°ƒç”¨ switchLogoDisplay('watermark') æˆ– switchLogoDisplay('footer') åˆ‡æ¢
            switchLogoDisplay('header');

            // åˆå§‹åŒ–é¢æ¿è°ƒæ•´åŠŸèƒ½
            initializeResizers();

            // æœåŠ¡å™¨é€‰æ‹©å˜åŒ–æ—¶è‡ªåŠ¨æµè§ˆ
            document.getElementById('sourceServer').addEventListener('change', function() {
                if (this.value) {
                    // æ ¹æ®æœåŠ¡å™¨è®¾ç½®é»˜è®¤è·¯å¾„
                    const defaultPath = getDefaultPath(this.value);
                    document.getElementById('sourcePath').value = defaultPath;
                    setTimeout(browseSource, 100);
                }
            });

            document.getElementById('targetServer').addEventListener('change', function() {
                if (this.value) {
                    // æ ¹æ®æœåŠ¡å™¨è®¾ç½®é»˜è®¤è·¯å¾„
                    const defaultPath = getDefaultPath(this.value);
                    document.getElementById('targetPath').value = defaultPath;
                    setTimeout(browseTarget, 100);
                }
            });
        });
    </script>
</body>
</html>
